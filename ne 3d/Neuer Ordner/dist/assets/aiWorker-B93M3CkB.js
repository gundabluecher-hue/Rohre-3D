(function(){"use strict";const N={BOT:{LEARNING:{ENABLED:!1,STORAGE_KEY:"mini-curve-fever-3d.bot-learning.v1",ALPHA:.16,GAMMA:.92,EPSILON_START:.35,EPSILON_MIN:.04,EPSILON_DECAY:.9995,MAX_STATES:2500,SAVE_EVERY_UPDATES:200,MIN_SAVE_INTERVAL_MS:4e3}}},x=Object.freeze(["NO_OP","YAW_LEFT","YAW_RIGHT","PITCH_UP","PITCH_DOWN","BOOST","USE_ITEM","SHOOT_ITEM"]),I=2,O=1,U=".lastgood",D="mini-curve-fever-3d.bot-learning.v1";function v(o,t,e){return Math.min(Math.max(o,t),e)}function A(o,t){if(!Number.isFinite(o))return t.length;for(let e=0;e<t.length;e++)if(o<t[e])return e;return t.length}function a(o,t=0){return Number.isFinite(o)?o:t}function q(o){return!o||o.length===0?0:o[Math.floor(Math.random()*o.length)]}function w(o){let t=2166136261;const e=String(o||"");for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t=Math.imul(t,16777619)>>>0;return t.toString(16).padStart(8,"0")}function T(o,t,e,s){return{epsilon:a(o,0),totalUpdates:Math.max(0,Math.floor(a(t,0))),totalReward:a(e,0),states:Array.isArray(s)?s:[]}}function C(o,t=Date.now()){const e=T(o==null?void 0:o.epsilon,o==null?void 0:o.totalUpdates,o==null?void 0:o.totalReward,o==null?void 0:o.states),s=w(JSON.stringify(e));return{version:I,savedAt:Math.max(0,Math.floor(a(t,Date.now()))),checksum:s,epsilon:e.epsilon,totalUpdates:e.totalUpdates,totalReward:e.totalReward,states:e.states}}class K{constructor(t={}){var s;const e=((s=N.BOT)==null?void 0:s.LEARNING)||{};this.storageKey=t.storageKey||e.STORAGE_KEY||D,this.alpha=a(t.alpha,a(e.ALPHA,.16)),this.gamma=a(t.gamma,a(e.GAMMA,.92)),this.epsilonStart=v(a(t.epsilonStart,a(e.EPSILON_START,.35)),0,1),this.epsilonMin=v(a(t.epsilonMin,a(e.EPSILON_MIN,.04)),0,1),this.epsilonDecay=v(a(t.epsilonDecay,a(e.EPSILON_DECAY,.9995)),.9,1),this.maxStates=Math.max(200,Math.floor(a(t.maxStates,a(e.MAX_STATES,2500)))),this.saveEveryUpdates=Math.max(1,Math.floor(a(t.saveEveryUpdates,a(e.SAVE_EVERY_UPDATES,200)))),this.minSaveIntervalMs=Math.max(0,Math.floor(a(t.minSaveIntervalMs,a(e.MIN_SAVE_INTERVAL_MS,4e3)))),this.actions=x.slice(),this.trainingEnabled=!!(t.trainingEnabled??e.ENABLED??!1),this.enabled=!0,this.epsilon=this.epsilonStart,this.totalUpdates=0,this.totalReward=0,this.updatesSinceSave=0,this.lastSaveAt=0,this.lastLoadedAt=0,this.epsilonOverride=null,this.backupStorageKey=`${this.storageKey}${U}`,this.qTable=new Map,this.stateMeta=new Map,this._loaded=this.load()}setEnabled(t){this.enabled=!!t}setTrainingEnabled(t){this.trainingEnabled=!!t}setEpsilonOverride(t){if(t==null||t===""){this.epsilonOverride=null;return}const e=Number(t);Number.isFinite(e)&&(this.epsilonOverride=v(e,this.epsilonMin,1),this.epsilon=this.epsilonOverride)}getActionName(t){return!Number.isInteger(t)||t<0||t>=this.actions.length?this.actions[0]:this.actions[t]}getActionCount(){return this.actions.length}encodeState({player:t,sense:e,arena:s,planarMode:n}){const i=e||{},c=Math.max(1,a(i.lookAhead,1)),h=a(i.localOpenness,0)/c,r=Number.isFinite(i.targetDistanceSq)?Math.sqrt(Math.max(0,i.targetDistanceSq)):1/0,d=t&&t.baseSpeed>0?a(t.speed/t.baseSpeed,1):1,l=Number.isFinite(i.nearestHumanDistanceSq)?Math.sqrt(Math.max(0,i.nearestHumanDistanceSq)):1/0,u=Math.max(0,Math.floor(a(i.humanAliveCount,0))),p=v(a(i.humanThreat,0),0,2);let g=1;if(!n&&t&&(s!=null&&s.bounds)){const R=(s.bounds.minY+s.bounds.maxY)*.5;t.position.y<R-5?g=0:t.position.y>R+5&&(g=2)}const f=A(a(i.forwardRisk,0),[.2,.4,.6,.85]),S=A(a(i.pressure,0),[.25,.5,.9,1.2]),y=A(h,[.25,.45,.65,.85]),E=A(r,[8,16,30,55]),m=A(d,[.9,1.1,1.4,1.8]),M=i.targetInFront?1:0,b=i.immediateDanger?1:0,F=i.projectileThreat?1:0,L=n?1:0,V=A(u,[1,2]),P=A(l,[10,20,35,55]),k=A(p,[.2,.45,.75,1.1]);return`f${f}|p${S}|o${y}|d${E}|s${m}|t${M}|i${b}|j${F}|h${g}|m${L}|hc${V}|hd${P}|ht${k}`}selectAction(t,e={}){if(!this.enabled||!t)return 0;const s=e.training!==!1,n=Array.isArray(e.allowedActions)?e.allowedActions:null,i=[];for(let l=0;l<this.actions.length;l++)(!n||n[l])&&i.push(l);if(i.length===0)return 0;const c=this._ensureState(t);if(s&&this.trainingEnabled&&Math.random()<this.epsilon)return q(i);let r=i[0],d=c[r];for(let l=1;l<i.length;l++){const u=i[l],p=c[u];p>d&&(d=p,r=u)}return r}updateTransition(t={}){const e=typeof t.stateKey=="string"?t.stateKey:"",s=typeof t.nextStateKey=="string"?t.nextStateKey:"",n=Number.isInteger(t.actionIndex)?t.actionIndex:0,i=a(t.reward,0),c=!!t.terminal,h=t.training!==!1;if(!e||n<0||n>=this.actions.length)return null;const r=this._ensureState(e),d=r[n];let l=0;if(!c&&s){const f=this._ensureState(s);l=f[0];for(let S=1;S<f.length;S++)f[S]>l&&(l=f[S])}const p=i+(c?0:this.gamma*l)-d,g=h&&this.trainingEnabled;return g&&(r[n]=d+this.alpha*p,this.totalUpdates++,this.totalReward+=i,this.updatesSinceSave++,this.epsilonOverride===null?this.epsilon=Math.max(this.epsilonMin,this.epsilon*this.epsilonDecay):this.epsilon=this.epsilonOverride,this._touchState(e),s&&this._touchState(s),this._pruneStatesIfNeeded(),this.save(!1)),{updated:g,tdError:p,qValue:r[n],epsilon:this.epsilon}}reset(t=!0){this.qTable.clear(),this.stateMeta.clear(),this.totalUpdates=0,this.totalReward=0,this.updatesSinceSave=0,this.epsilon=this.epsilonOverride===null?this.epsilonStart:this.epsilonOverride,t&&this.save(!0)}exportDump(t=Date.now()){const e=Math.max(0,Math.floor(a(t,Date.now())));return{savedAt:e,epsilon:this.epsilon,totalUpdates:this.totalUpdates,totalReward:this.totalReward,states:this._serializeStates(e)}}importDumpAndSave(t,e={}){const s=this._normalizeExternalDump(t);if(!s)return!1;this.qTable.clear(),this.stateMeta.clear();const n=this.actions.length;for(let i=0;i<s.states.length;i++){const c=s.states[i],h=c[0],r=c[1],d=c[2],l=c[3],u=new Float64Array(n);for(let p=0;p<n;p++)u[p]=a(r[p],0);this.qTable.set(h,u),this.stateMeta.set(h,{visits:Math.max(1,Math.floor(a(d,1))),lastSeen:Math.max(0,Math.floor(a(l,s.savedAt)))})}if(Number.isFinite(s.epsilon)){const i=v(s.epsilon,this.epsilonMin,this.epsilonStart);this.epsilon=this.epsilonOverride===null?i:this.epsilonOverride}return this.totalUpdates=Math.max(0,Math.floor(a(s.totalUpdates,0))),this.totalReward=a(s.totalReward,0),this.lastLoadedAt=Date.now(),this.updatesSinceSave=0,this._pruneStatesIfNeeded(),e.save!==!1&&this.save(!0),!0}mergeDumpAndSave(t,e={}){const s=this._normalizeExternalDump(t);if(!s)return!1;const n=this.actions.length;for(let r=0;r<s.states.length;r++){const d=s.states[r],l=d[0],u=d[1],p=Math.max(1,Math.floor(a(d[2],1))),g=Math.max(0,Math.floor(a(d[3],s.savedAt))),f=this.qTable.get(l),S=this.stateMeta.get(l);if(!f||!S){const m=new Float64Array(n);for(let M=0;M<n;M++)m[M]=a(u[M],0);this.qTable.set(l,m),this.stateMeta.set(l,{visits:p,lastSeen:g});continue}const y=Math.max(1,Math.floor(a(S.visits,1))),E=y+p;for(let m=0;m<n;m++){const M=a(f[m],0),b=a(u[m],0);f[m]=(M*y+b*p)/E}S.visits=E,S.lastSeen=Math.max(Math.max(0,Math.floor(a(S.lastSeen,0))),g)}const i=this.totalUpdates,c=Math.max(0,Math.floor(a(s.totalUpdates,0)));this.totalUpdates=Math.max(this.totalUpdates,c);const h=a(s.totalReward,0);if((c>i||Math.abs(h)>Math.abs(this.totalReward))&&(this.totalReward=h),Number.isFinite(s.epsilon)){const r=Math.min(this.epsilon,s.epsilon),d=v(r,this.epsilonMin,this.epsilonStart);this.epsilon=this.epsilonOverride===null?d:this.epsilonOverride}return this.lastLoadedAt=Date.now(),this.updatesSinceSave=Math.max(1,this.updatesSinceSave),this._pruneStatesIfNeeded(),e.save!==!1&&this.save(!0),!0}getStats(){return{loaded:this._loaded,enabled:this.enabled,trainingEnabled:this.trainingEnabled,states:this.qTable.size,maxStates:this.maxStates,epsilon:this.epsilon,epsilonStart:this.epsilonStart,epsilonMin:this.epsilonMin,totalUpdates:this.totalUpdates,totalReward:this.totalReward,storageKey:this.storageKey,backupStorageKey:this.backupStorageKey,lastSaveAt:this.lastSaveAt,lastLoadedAt:this.lastLoadedAt,updatesSinceSave:this.updatesSinceSave,saveEveryUpdates:this.saveEveryUpdates,minSaveIntervalMs:this.minSaveIntervalMs,epsilonOverride:this.epsilonOverride}}save(t=!1){if(typeof localStorage>"u")return!1;const e=Date.now();if(!t&&(this.updatesSinceSave<this.saveEveryUpdates||e-this.lastSaveAt<this.minSaveIntervalMs))return!1;const s=C({epsilon:this.epsilon,totalUpdates:this.totalUpdates,totalReward:this.totalReward,states:this._serializeStates(e)},e),n=JSON.stringify(s);try{const i=localStorage.getItem(this.storageKey);return i&&localStorage.setItem(this.backupStorageKey,i),localStorage.setItem(this.storageKey,n),this.lastSaveAt=e,this.updatesSinceSave=0,!0}catch{try{return localStorage.setItem(this.storageKey,n),this.lastSaveAt=e,this.updatesSinceSave=0,!0}catch{return!1}}}load(){if(typeof localStorage>"u")return!1;try{const t=localStorage.getItem(this.storageKey);if(this._hydrateFromRaw(t))return!0;const e=localStorage.getItem(this.backupStorageKey);if(!this._hydrateFromRaw(e))return!1;try{e&&localStorage.setItem(this.storageKey,e)}catch{}return!0}catch{return!1}}_serializeStates(t=Date.now()){const e=[];for(const[s,n]of this.qTable.entries()){const i=this.stateMeta.get(s)||{visits:1,lastSeen:t};e.push([s,Array.from(n),Math.max(1,Math.floor(i.visits||1)),Math.max(0,Math.floor(i.lastSeen||t))])}return e}_normalizeExternalDump(t){const e=t&&typeof t=="object"?t:null;if(!e||!Array.isArray(e.states))return null;const s=Date.now(),n=Math.max(0,Math.floor(a(e.savedAt??e.timestamp,s))),i=Number.isFinite(e.epsilon)?e.epsilon:null,c=Math.max(0,Math.floor(a(e.totalUpdates,0))),h=a(e.totalReward,0),r=[],d=this.actions.length;for(let l=0;l<e.states.length;l++){const u=e.states[l];if(!Array.isArray(u)||typeof u[0]!="string"||!Array.isArray(u[1]))continue;const p=new Array(d);for(let S=0;S<d;S++)p[S]=a(u[1][S],0);const g=Math.max(1,Math.floor(a(u[2],1))),f=Math.max(0,Math.floor(a(u[3],n)));r.push([u[0],p,g,f])}return r.length===0?null:{savedAt:n,epsilon:i,totalUpdates:c,totalReward:h,states:r}}_hydrateFromRaw(t){if(!t)return!1;let e=null;try{e=JSON.parse(t)}catch{return!1}if(!e||!Array.isArray(e.states))return!1;const s=Number(e.version);if(Number.isFinite(s)&&s!==I&&s!==O)return!1;if(s===I&&typeof e.checksum=="string"){const h=T(e.epsilon,e.totalUpdates,e.totalReward,e.states),r=w(JSON.stringify(h));if(e.checksum!==r)return!1}this.qTable.clear(),this.stateMeta.clear();const n=this.actions.length,i=Date.now();for(let h=0;h<e.states.length;h++){const r=e.states[h];if(!Array.isArray(r)||r.length<2)continue;const d=r[0],l=r[1],u=a(r[2],1),p=a(r[3],i);if(typeof d!="string"||!Array.isArray(l))continue;const g=new Float64Array(n);for(let f=0;f<n;f++)g[f]=a(l[f],0);this.qTable.set(d,g),this.stateMeta.set(d,{visits:Math.max(1,Math.floor(u)),lastSeen:Math.max(0,Math.floor(p))})}const c=v(a(e.epsilon,this.epsilonStart),this.epsilonMin,this.epsilonStart);return this.epsilon=this.epsilonOverride===null?c:this.epsilonOverride,this.totalUpdates=Math.max(0,Math.floor(a(e.totalUpdates,0))),this.totalReward=a(e.totalReward,0),this.lastSaveAt=Math.max(0,Math.floor(a(e.savedAt,this.lastSaveAt))),this.lastLoadedAt=i,this.updatesSinceSave=0,this._pruneStatesIfNeeded(),!0}_ensureState(t){return this.qTable.has(t)||(this.qTable.set(t,new Float64Array(this.actions.length)),this.stateMeta.set(t,{visits:1,lastSeen:Date.now()})),this.qTable.get(t)}_touchState(t){const e=Date.now(),s=this.stateMeta.get(t);if(!s){this.stateMeta.set(t,{visits:1,lastSeen:e});return}s.visits=Math.max(1,s.visits+1),s.lastSeen=e}_pruneStatesIfNeeded(){if(this.qTable.size<=this.maxStates)return;const t=this.qTable.size-this.maxStates,e=[];for(const[s,n]of this.stateMeta.entries())e.push({key:s,visits:a(n==null?void 0:n.visits,1),lastSeen:a(n==null?void 0:n.lastSeen,0)});e.sort((s,n)=>s.visits!==n.visits?s.visits-n.visits:s.lastSeen-n.lastSeen);for(let s=0;s<t&&s<e.length;s++)this.qTable.delete(e[s].key),this.stateMeta.delete(e[s].key)}}const _=new Map;self.onmessage=o=>{const t=o.data;if(!t||!t.type)return;if(t.type==="INIT"){const s=new K(t.options);if(t.dump){s.qTable.clear(),s.stateMeta.clear();const n=Array.isArray(t.dump.states)?t.dump.states:[];for(const i of n){if(!Array.isArray(i)||typeof i[0]!="string"||!Array.isArray(i[1]))continue;const c=new Float64Array(s.actions.length);for(let h=0;h<s.actions.length;h++)c[h]=i[1][h]||0;s.qTable.set(i[0],c),s.stateMeta.set(i[0],{visits:i[2],lastSeen:i[3]})}s.epsilon=Number.isFinite(t.dump.epsilon)?t.dump.epsilon:s.epsilon,s.totalUpdates=Number.isFinite(t.dump.totalUpdates)?t.dump.totalUpdates:s.totalUpdates,s.totalReward=Number.isFinite(t.dump.totalReward)?t.dump.totalReward:s.totalReward,s.lastSaveAt=Number.isFinite(t.dump.savedAt)?t.dump.savedAt:s.lastSaveAt}s.save=n=>{const i=Date.now();if(!n&&(s.updatesSinceSave<s.saveEveryUpdates||i-s.lastSaveAt<s.minSaveIntervalMs))return!1;const c=[];for(const[h,r]of s.qTable.entries()){const d=s.stateMeta.get(h)||{visits:1,lastSeen:i};c.push([h,Array.from(r),d.visits,d.lastSeen])}return self.postMessage({type:"SAVE_SYNC",engineId:t.engineId,dump:{savedAt:i,epsilon:s.epsilon,totalUpdates:s.totalUpdates,totalReward:s.totalReward,states:c}}),s.lastSaveAt=i,s.updatesSinceSave=0,!0},_.set(t.engineId,s),self.postMessage({type:"INIT_ACK",engineId:t.engineId});return}const e=_.get(t.engineId);if(e){if(t.type==="SELECT_ACTION"){const s=e.selectAction(t.stateKey,t.options);self.postMessage({type:"ACTION_ACK",engineId:t.engineId,reqId:t.reqId,action:s})}else if(t.type==="UPDATE_TRANSITION"){const s=e.updateTransition(t.params);t.reqId&&self.postMessage({type:"TRANSITION_ACK",engineId:t.engineId,reqId:t.reqId,result:s})}else if(t.type==="SET_PARAMS")t.params.enabled!==void 0&&e.setEnabled(t.params.enabled),t.params.trainingEnabled!==void 0&&e.setTrainingEnabled(t.params.trainingEnabled),t.params.epsilonOverride!==void 0&&e.setEpsilonOverride(t.params.epsilonOverride);else if(t.type==="ENCODE_STATE"){const s=e.encodeState(t.params);self.postMessage({type:"ENCODE_ACK",engineId:t.engineId,reqId:t.reqId,stateKey:s})}else if(t.type==="RESET")e.reset(t.saveAfterReset);else if(t.type==="FORCE_SAVE")e.save(t.force);else if(t.type==="REQUEST_DUMP"){const s=[];for(const[n,i]of e.qTable.entries())s.push([n,Array.from(i)]);self.postMessage({type:"DUMP_ACK",engineId:t.engineId,reqId:t.reqId,dump:{states3D:s,statesPlanar:s,engine3D:{totalUpdates:e.totalUpdates,totalReward:e.totalReward},enginePlanar:{totalUpdates:e.totalUpdates,totalReward:e.totalReward}}})}}}})();
